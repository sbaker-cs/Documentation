= Penetration Testing
:toc:

https://my.ine.com/INE/courses/d71214de/[INE System Security penetration-testing-system-security]

== Architecture Fundamentals

.Architecture naming convention prefix
[%autowidth]
|===
| Architecture | Naming
| 8-bit  | _ H / _ L
| 16-bit | _ _
| 32-bit | E _ _
| 64-bit | R _ _
|===

.Instruction naming convention
[%autowidth]
[cols="^,^,^,^,^,^,^,^,^"]
|===
| Accumulator | Count | Data | Base | Stack Pointer | Base Pointer | Source | Destination | Instruction Pointer
| AX | CX | DX | BX | SP | BP | SI | DI | IP
|===

.Instructions
[%autowidth]
[cols="^,^,^,^"]
|===
| Data Transfer | Arithmethic | Control Flow | Other
| MOV, XCHG, PUSH, POP | ADD, SUB, MUL, XOR, NOT | CALL, RET, LOOP, Jxx | STI, CLI, IN, OUT
|===

[discrete]
=== Stack Frame

On function return SP becomes BP which contains previous stack frame BP, pops it to BP again. BP becomes previous stack frame BP and SP is now on top of it.
[source, nasm]
----
move sp, pb
pop bp
ret
----

== Assembler Debuggers and Tool Arsenal

.Compile Command
[source, nasm]
----
gcc -m32 <source-file>.c -o <executable>.exe
----

.Decompile Command
[source, nasm]
----
objdump.exe -d -Mintel <executable>.exe > output.s
----

== Buffer Overflow

[discrete]
=== Find

.Vulnerable functions ie:
[source, nasm]
----
strcpy, strcat, gets, fgets, scanf, fscanf, printf, vsprintf, memcpy
----

[discrete]
=== Exploit

Using a pattern generator or mona plugin

[%collapsible]
.pattern snippet
====
[source, python]
----
include::../INE_BufferOverflow/pattern.py[]
----
====

[source, nasm]
----
mona pc xxx
mona po value
----

[discrete]
=== Mitigate

|===
| ASLR | Address Space Layout Ranomization
| DEP | Data Executetion Prevention
| Stack Canary | Stack safety
|===

== Shellcode

.RCE Types:
* Connect back
* Bind shell
* Socket reuse
* Download & Execute
* Staged
** Egg-Hunt
** Omelet

[discrete]
=== Encoding

[discrete]
==== Null-Free

[%autowidth]
[cols="^,^,^"]
|===
| Machine Code | Assembly | Comment
| B8 00000000 | MOV EAX, 0 | Set EAX to 0
| 33 C0 | XOR EAX, EAX | Set EAX to 0
| B8 78563412 +
2D 78563412 | MOVE EAX, 0x12345678 +
SUB EAX, 0x12345678 | Set EAX to 0
|===

[discrete]
==== Alphanumeric

SMC

[discrete]
=== Pushing Shellcode

[discrete]
==== nasm OpCode footnote:[https://github.com/HJLebbink/asm-dude/wiki]

[cols=".^,.^,.^,.^"]
|===
| Opcode | Instruction | 64-Bit Mode | Description
| 6A | PUSH imm8 ^| ✓ | Push byte
| 68 | PUSH imm16 ^| ✓ | Push word/dword
| 8B | MOV r32,r/m32 ^| ✓ | Move r/m32 to r32
| B8 | MOV r32, imm32 ^| ✓ | Move imm32 to r32
| 33 | XOR r32,r/m32 ^|  | r32 XOR r/m32
| FF | CALL r/m32 ^|  ✓ | Call near, absolute indirect, address given in r/m32
|===

* Pushing variables on stack
** Reversed order
** Strings are 4 bytes at at time and reversed

[cols="^.^,^,^"]
|===
| Original code 2.1+| Calc.exe
1.2+| Hex
| .exe | \x2e \x65 \x78 \x65
| calc | \x63 \x61 \x6c \x63
1.3+| ByteCode
2.1+a|
[subs="quotes"]
[source, bytecode]
----
 *\x68*\x20\x20\x20\x00    //PUSH string terminator
----
2.1+a|
[subs="quotes"]
[source, bytecode]
----
*\x68*\x2e\x65\x78\x65    //PUSH ".exe"
----
2.1+a|
[subs="quotes"]
[source, bytecode]
----
 *\x68*\x63\x61\x6c\x63    //PUSH "calc"
----
|===


``ShellExecuteA(0, "open", "cmd", NULL, 0, SW_MAXIMIZE);``
[source, bytecode]
----
\x68\x63\x6d\x64\x00     //PUSH "cmd"
\x8B\xDC                //MOV EBX, ESP
\x6A\x00                //PUSH string terminator
\x68\x6f\x70\x65\x6e    //PUSH "open"
\x8B\xCC                //MOV ECX, ESP

\x6A\x03                //PUSH 3
\x33\xC0                //XOR EAX, EAX - Sets EAX to 0
\x50                    //PUSH EAX
\x50                    //PUSH EAX
\x53                    //PUSH EBX
\x51                    //PUSH ECX
\x50                    //PUSH EAX
\xB8_\x78\x70\x70\x76_   //MOV ShellExecuteA function address in AEX
\xff\xD0                //CALL EAX - calls ShellExecuteA
----
.Null-Free
[source, bytecode]
----
\x33\xDB                    //XOR EBX, EBX - Zero out EBX and other flags
\xBB\x52\x5C\x53\xEF        //MOV EBX - EF5C52 == 00646d63 - 11111111
\x81\xC3\x11\x11\x11\x11    //ADD EBX 11111111
\x53                        //PUSH EBX
\x8B\xDC                    //MOV EBX, ESP

\x33\xC0                    //XOR EAX, EAX - Zero out EAX
\x50                        //PUSH EAX - Push string terminator
\x68\x6f\x70\x65\x6e        //PUSH "open"
\x8B\xCC                    //MOV ECX, ESP

\x6A\x03                    //PUSH 3
\x33\xC0                    //XOR EAX, EAX - Sets EAX to 0
\x50                        //PUSH EAX
\x50                        //PUSH EAX
\x53                        //PUSH EBX
\x51                        //PUSH ECX
\x50                        //PUSH EAX
\xB8_\x78\x70\x70\x76_      //MOV ShellExecuteA function address in AEX
\xff\xD0                    //CALL EAX - calls ShellExecuteA
----

[discrete]
=== Debugging

.debugging snippet
[source, c]
----
char code[] = "";
int main(int argc, char **argv)
{
    //LoadLibraryA("lib.dll");
    int (*func)();
    func = (int (*) ()) code;
    (int)  (*func) ();
}
----

== Cryptography

[cols="^.^,^.^,^.^,^.^,^.^"]
|===
5.1+|Classification of Crypto-Algorithms
2.1+|User of Keys 3.1+| Handling of data
1.2+| Symmetric-key Cryptography 1.2+| Public-key Cryptography 2.1+| Block Cipher
1.2+| Stream Cipher | ECB | CBC
|===

[discrete]
=== Key exchange

.RSA
Asymetric, public key is use to encrypt and private key to decrypt.

[cols="^,^"]
|===
| Block Cipher | Stream Cipher
| DES, AES | RC4, A5/1
|===

.ECB
Electronic Code Book +
Each block encrypted seperately. Identical plain block will have identical cypher block

.CBC
Cipher-block chaining +
Each block is derived from the previous block. Identical plain block will have different cypher block

[discrete]
=== Crypto Attacks

* Known Only Attack
* Chosen Attack
* Adaptive Chosen Attack

[]
* Brute force
* Dictionary
* Rainbow
* Side Channel
* Birthday


== Malware

[discrete]
=== Streams

.Writing and reading to metadata stream
[source, bash]
----
metadata >> test.txt:hstream
more < test.txt:hstream
----

[discrete]
=== Hooking

|===
| IAT | Import Address Table | EXE, DLL
| EAT | Export Address Table | DLL
| Inline |  |
|===
